#!/usr/bin/env bash

# Close any open System Preferences panes
osascript -e 'tell application "System Preferences" to quit'

# Ask for the administrator password upfront
sudo -v

# Keep-alive: update existing `sudo` time stamp until `.macos` has finished
while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &

###############################################################################
# General UI/UX                                                               #
###############################################################################

# Set computer name (as done via System Preferences → Sharing)
# Use environment variable HOSTNAME, fallback to "Ghost" if not set
COMPUTER_NAME=${HOSTNAME:-"Ghost"}
sudo scutil --set ComputerName "$COMPUTER_NAME"
sudo scutil --set HostName "$COMPUTER_NAME"
sudo scutil --set LocalHostName "$COMPUTER_NAME"

# Set appearance to Dark Mode
osascript -e 'tell application "System Events" to tell appearance preferences to set dark mode to true'

# Set sidebar icon size to medium (for better dark mode appearance)
defaults write NSGlobalDomain NSTableViewDefaultSizeMode -int 2

###############################################################################
# Dock & Menu Bar                                                             #
###############################################################################

# System Preferences > Dock & Menu Bar > Automatically hide and show the Dock
defaults write com.apple.dock autohide -bool true

###############################################################################
# Mission Control                                                             #
###############################################################################

# System Preference > Mission Control > Automatically rearrange Spaces based on most recent use
defaults write com.apple.dock mru-spaces -bool false

###############################################################################
# Hot Corners                                                                 #
###############################################################################

# Top right corner → Start screen saver
defaults write com.apple.dock wvous-tr-corner -int 5
defaults write com.apple.dock wvous-tr-modifier -int 0

###############################################################################
# Finder                                                                      #
###############################################################################

# Desktop > Show View Options > Sort By: Name
/usr/libexec/PlistBuddy -c "Set :DesktopViewSettings:IconViewSettings:arrangeBy name" ~/Library/Preferences/com.apple.finder.plist

# Finder > Show View Options > Sort By: Name
/usr/libexec/PlistBuddy -c "Set :StandardViewSettings:IconViewSettings:arrangeBy name" ~/Library/Preferences/com.apple.finder.plist

###############################################################################
# Security & Privacy                                                          #
###############################################################################

# Enable FileVault (full disk encryption)
if sudo fdesetup status | grep -q "FileVault is Off"; then
    echo "Enabling FileVault..."
    sudo fdesetup enable -user "$USER" || echo "FileVault setup failed or requires manual setup"
else
    echo "FileVault is already enabled"
fi

# Enable the built-in firewall
sudo defaults write /Library/Preferences/com.apple.alf globalstate -int 1

# Enable stealth mode (don't respond to ICMP ping requests or connection attempts from closed TCP and UDP ports)
sudo defaults write /Library/Preferences/com.apple.alf stealthenabled -bool true

# Disable automatic login
sudo defaults delete /Library/Preferences/com.apple.loginwindow autoLoginUser 2>/dev/null || echo "Auto login already disabled"

# Require password immediately after sleep or screen saver begins

defaults -currentHost write -globalDomain askForPassword -int 1
defaults -currentHost write -globalDomain askForPasswordDelay -int 0

# Disable guest account
sudo defaults write /Library/Preferences/com.apple.loginwindow GuestEnabled -bool false

# Disable remote login (SSH)
sudo systemsetup -setremotelogin off

# Disable remote management
sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -deactivate -stop

###############################################################################
# Kill affected applications                                                  #
###############################################################################

for app in "Dock" "Finder"; do
    echo "Killing ${app}"
    killall "${app}" &> /dev/null
done

echo "Done. Note that some of these changes require a logout/restart to take effect."
